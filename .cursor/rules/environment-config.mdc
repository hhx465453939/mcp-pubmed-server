---
globs: *.json,*.env*,*.md
description: 环境配置和部署指导
---

# 环境配置和部署规范

## 环境变量配置

### 必需环境变量
```bash
# .env 文件配置
PUBMED_API_KEY=your_ncbi_api_key_here
PUBMED_EMAIL=your_email@example.com
ABSTRACT_MODE=quick  # 或 deep
FULLTEXT_MODE=disabled  # disabled, enabled, auto
```

### 环境变量说明
- `PUBMED_API_KEY`: NCBI API密钥，从 [NCBI API Key Management](https://www.ncbi.nlm.nih.gov/account/settings/) 获取
- `PUBMED_EMAIL`: 邮箱地址，用于PubMed API调用标识
- `ABSTRACT_MODE`: 摘要模式
  - `quick`: 1500字符，快速检索
  - `deep`: 6000字符，深度检索（需要≥120k tokens上下文）
- `FULLTEXT_MODE`: 全文模式
  - `disabled`: 禁用全文功能（默认）
  - `enabled`: 启用全文检测，手动下载
  - `auto`: 启用全文检测，自动下载可用的OA论文

## MCP客户端配置

### 1. Cline (VS Code Extension)
```json
{
  "mcpServers": {
    "pubmed-data-server": {
      "command": "node",
      "args": ["./src/index.js"],
      "cwd": "完整路径/to/mcp-pubmed-server",
      "env": {
        "PUBMED_API_KEY": "你的API密钥",
        "PUBMED_EMAIL": "你的邮箱地址",
        "ABSTRACT_MODE": "deep",
        "FULLTEXT_MODE": "enabled"
      }
    }
  }
}
```

### 2. Cherry Studio (Windows)
```json
{
  "mcpServers": {
    "pubmed-data-server": {
      "name": "pubmed-data-server",
      "type": "stdio",
      "isActive": true,
      "command": "node",
      "args": ["Y:/software/mcp-pubmed-server/src/index.js"],
      "env": {
        "PUBMED_API_KEY": "你的API密钥",
        "PUBMED_EMAIL": "你的邮箱地址",
        "ABSTRACT_MODE": "deep",
        "FULLTEXT_MODE": "enabled"
      }
    }
  }
}
```

### 3. Claude Desktop
```json
{
  "mcpServers": {
    "pubmed-data-server": {
      "command": "node",
      "args": ["/path/to/mcp-pubmed-server/src/index.js"],
      "cwd": "/path/to/mcp-pubmed-server",
      "env": {
        "PUBMED_API_KEY": "你的API密钥",
        "PUBMED_EMAIL": "你的邮箱地址",
        "ABSTRACT_MODE": "deep",
        "FULLTEXT_MODE": "enabled"
      }
    }
  }
}
```

## 部署检查清单

### 前置要求
- [ ] Node.js v18.0.0+ 已安装
- [ ] 项目依赖已安装 (`npm install`)
- [ ] `.env` 文件已配置
- [ ] PubMed API密钥已获取
- [ ] 服务器可正常启动

### 配置验证
```bash
# 测试服务器启动
node src/index.js
# 应该看到: "PubMed Data Server v2.0 running on stdio"

# 检查环境变量
echo $PUBMED_API_KEY
echo $PUBMED_EMAIL
echo $ABSTRACT_MODE
```

### 故障排除

#### 常见错误
1. **"找不到模块 @modelcontextprotocol/sdk"**
   ```bash
   npm install
   ```

2. **"PubMed API调用失败"**
   - 检查API密钥是否正确
   - 确认网络连接正常
   - 等待速率限制重置

3. **"环境变量未设置"**
   - 确保 `.env` 文件存在
   - 检查变量名拼写

4. **Cherry Studio配置错误**
   - 使用完整路径到 `src/index.js`
   - 不要使用 `cwd` 参数
   - 使用正斜杠 `/` 或双反斜杠 `\\`

## 性能配置

### 缓存配置
```javascript
// 内存缓存配置
const CACHE_TIMEOUT = 5 * 60 * 1000; // 5分钟
const MAX_CACHE_SIZE = 100; // 最大100个条目

// 文件缓存配置
const PAPER_CACHE_EXPIRY = 30 * 24 * 60 * 60 * 1000; // 30天
```

### 速率限制
```javascript
const RATE_LIMIT_DELAY = 334; // PubMed限制：3请求/秒
const REQUEST_TIMEOUT = 30000; // 30秒请求超时
```

## 安全配置

### API密钥安全
- 不要在代码中硬编码API密钥
- 使用环境变量存储敏感信息
- 定期轮换API密钥

### 网络配置
- 确保防火墙允许HTTPS连接到PubMed API
- 配置代理服务器（如需要）

## 监控和日志

### 日志级别
```javascript
// 使用 console.error 输出调试信息（MCP特性）
console.error(`[PubMed Search] Starting search for: "${query}"`);
console.error(`[Cache] Hit for key: ${key.substring(0, 50)}...`);
```

### 性能监控
```javascript
const startTime = Date.now();
// ... 执行操作
const endTime = Date.now();
console.error(`[Performance] Operation completed in ${endTime - startTime}ms`);
```